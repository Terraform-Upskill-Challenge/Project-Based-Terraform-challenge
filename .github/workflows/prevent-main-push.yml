name: Prevent Direct Push to Main

on:
  push:
    branches:
      - main
      - master

jobs:
  prevent-main-push:
    name: Block Direct Pushes to Main
    runs-on: ubuntu-latest
    steps:
      - name: Check commit author and message
        id: check-commit
        run: |
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          ACTOR="${{ github.actor }}"
          
          echo "Commit Author: $COMMIT_AUTHOR"
          echo "GitHub Actor: $ACTOR"
          echo "Commit Message: $COMMIT_MESSAGE"
          
          # Check if this looks like a direct push (not a merge commit)
          if echo "$COMMIT_MESSAGE" | grep -qE "^Merge pull request|^Merge branch"; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "âœ… This appears to be a merge commit (from PR)"
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  This appears to be a direct push"
          fi

      - name: Check if user is repository admin
        id: check-admin
        run: |
          # Check if the actor has admin permissions
          # Repository admins/owners can push directly for initial setup
          ACTOR="${{ github.actor }}"
          REPO_OWNER="${{ github.repository_owner }}"
          
          # Allow repository owners/admins for initial setup
          if [ "$ACTOR" == "$REPO_OWNER" ]; then
            echo "is_admin=true" >> $GITHUB_OUTPUT
            echo "âœ… Actor is repository owner - allowing for initial setup"
          else
            echo "is_admin=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Actor is not repository owner"
          fi

      - name: Block direct push to main branch
        run: |
          ACTOR="${{ github.actor }}"
          IS_MERGE="${{ steps.check-commit.outputs.is_merge }}"
          IS_ADMIN="${{ steps.check-admin.outputs.is_admin }}"
          
          # Allow merge commits and repository admins (for initial setup)
          if [ "$IS_MERGE" == "true" ]; then
            echo "âœ… This is a merge commit from a Pull Request - allowed"
            exit 0
          elif [ "$IS_ADMIN" == "true" ]; then
            echo "âš ï¸  WARNING: Direct push to main by repository owner detected"
            echo ""
            echo "This is allowed for initial setup, but please use Pull Requests"
            echo "for all future changes to maintain code quality and reviews."
            echo ""
            echo "For students and future changes, use this workflow:"
            echo "1. Create a feature branch: git checkout -b feat/day-XX-description"
            echo "2. Make changes and commit"
            echo "3. Push branch and create Pull Request"
            echo ""
            exit 0
          else
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš« DIRECT PUSH TO MAIN BRANCH DETECTED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Direct pushes to the main branch are NOT allowed!"
            echo ""
            echo "ğŸ‘¤ Actor: $ACTOR"
            echo "ğŸ“ Branch: ${{ github.ref }}"
            echo ""
            echo "ğŸ“ CORRECT WORKFLOW:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "1. Create a feature branch:"
            echo "   git checkout -b feat/day-XX-description"
            echo ""
            echo "2. Make your changes and commit:"
            echo "   git add ."
            echo "   git commit -m 'feat(day-XX): your commit message'"
            echo ""
            echo "3. Push to your fork:"
            echo "   git push origin feat/day-XX-description"
            echo ""
            echo "4. Create a Pull Request on GitHub"
            echo ""
            echo "ğŸ“š See CONTRIBUTING.md for detailed instructions"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
